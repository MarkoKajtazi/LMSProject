{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
    <style>
        .chat-shell {
            border: 1px solid #e5e7eb;
            border-radius: .75rem;
            padding: .75rem;
            background: #fff;
        }

        .chat-messages {
            height: 60vh;
            overflow-y: auto;
            padding: .25rem .25rem 0;
        }

        .message {
            display: flex;
            margin-bottom: .5rem;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .bubble {
            max-width: 70%;
            padding: .5rem .75rem;
            border-radius: 1rem;
            line-height: 1.35;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        /* User bubble (right) */
        .message.user .bubble {
            background: var(--bs-primary);
            color: #fff;
            border-top-right-radius: .25rem;
        }

        /* Assistant bubble (left) */
        .message.assistant .bubble {
            background: var(--bs-secondary-bg, #f1f3f5);
            color: var(--bs-body-color, #212529);
            border-top-left-radius: .25rem;
        }

        /* Typing / thinking dots */
        .thinking {
            opacity: .8;
        }

        .typing {
            display: inline-flex;
            gap: .25rem;
            align-items: center;
        }

        .typing .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            opacity: .35;
            animation: blink 1s infinite ease-in-out;
        }

        .typing .dot:nth-child(2) {
            animation-delay: .2s;
        }

        .typing .dot:nth-child(3) {
            animation-delay: .4s;
        }

        @keyframes blink {
            0%, 100% {
                opacity: .25;
                transform: translateY(0)
            }
            50% {
                opacity: 1;
                transform: translateY(-2px)
            }
        }

        /* Input row */
        .input-row {
            display: flex;
            gap: .5rem;
            align-items: center;
            margin-top: .75rem;
        }

        .input-row input[type="text"] {
            flex: 1 1 auto;
            min-width: 200px;
            height: 42px;
        }

        .btn-icon {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Course list (right column) */
        .course-item {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .25rem 0;
            text-decoration: none;
            background: transparent;
            border: 0;
            cursor: pointer;
        }

        /* Remove outlines / shadows for focus/active */
        .course-item:focus,
        .course-item:focus-visible,
        .course-item:active {
            outline: none;
            box-shadow: none;
        }

        /* Name styles: inactive vs active (bold only, no outline) */
        .course-item .name {
            font-weight: 600;
            color: var(--bs-secondary);
        }

        .course-item.active .name {
            font-weight: 800;
            color: var(--bs-body-color);
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="container align-items-center d-flex my-3 p-0">
            <a href="{% url 'home' %}" class="btn">
                <img src="{% static 'images/arrow-logo.svg' %}" width="30px" height="30px">
            </a>
            <p class="font-weight-bold fs-3 fw-bold text-center m-0">
                AI Assistant
            </p>
        </div>

        <div class="d-flex">
            <!-- Chat area -->
            <div class="chat-shell w-75 me-3">
                <div id="chat" class="chat-messages"></div>

                <div class="input-row">
                    <input id="questionInput" type="text"
                           class="form-control rounded-pill border-1 border-secondary-subtle px-3"
                           placeholder="Ask AI-assistant" required/>
                    <button class="btn btn-icon" id="askBtn" aria-label="Send">
                        <img src="{% static 'images/send-logo.svg' %}" alt="" style="height: 30px; width: 30px;">
                    </button>
                </div>
            </div>

            <!-- Course picker (bold when active, no outline) -->
            <div class="container bg-white m-0 p-3 rounded-4 w-25">
                <p class="text-black fs-5 text-center mb-3">Courses</p>
                <div class="d-flex flex-column align-items-start">
                    {% if courses %}
                        {% for c in courses %}
                            <a class="course-item m-0 p-0" role="button" tabindex="0" data-course-id="{{ c.id }}"
                               href="javascript:void(0)">
                                <span class="name">{{ c.name }}</span>
                            </a>
                        {% endfor %}
                        <!-- hidden selected course id; will be set to first on load -->
                        <input type="hidden" id="courseId" value="{% if courses.0 %}{{ courses.0.id }}{% endif %}">
                    {% else %}
                        <p class="text-secondary text-center">No courses available</p>
                        <input type="hidden" id="courseId" value="">
                    {% endif %}
                </div>
                <input id="k" type="number" min="1" value="{{ assistant_default_k|default:6 }}" hidden/>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        const ENDPOINT = "/assistant/response/"; // trailing slash required

        const chatEl = document.getElementById("chat");
        const inputEl = document.getElementById("questionInput");
        const sendBtn = document.getElementById("askBtn");
        const kEl = document.getElementById("k");
        const hiddenCourse = document.getElementById("courseId");
        const courseButtons = Array.from(document.querySelectorAll(".course-item"));

        // Auto-select the first course on load
        (function selectFirstOnLoad() {
            if (courseButtons.length === 0) return;
            const first = courseButtons[0];
            first.classList.add("active"); // bold text
            hiddenCourse.value = first.dataset.courseId;
            // Ensure first label uses active color/weight
            const name = first.querySelector(".name");
            if (name) {
                name.classList.add("fw-bold");
            } // optional extra bold
        })();

        // Clicking a course sets it active and updates hidden value
        courseButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                courseButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                hiddenCourse.value = btn.dataset.courseId;
            });
            // Also allow keyboard activation (Enter/Space)
            btn.addEventListener("keydown", (e) => {
                if (e.key === "Enter" || e.key === " ") {
                    e.preventDefault();
                    btn.click();
                }
            });
        });

        function scrollToBottom() {
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        function appendMessage(role, text, opts = {}) {
            const msg = document.createElement("div");
            msg.className = `message ${role}`;
            const bubble = document.createElement("div");
            bubble.className = "bubble";
            bubble.textContent = text;
            if (opts.muted) bubble.style.opacity = ".85";
            msg.appendChild(bubble);
            chatEl.appendChild(msg);
            scrollToBottom();
            return msg;
        }

        function appendThinking() {
            const msg = document.createElement("div");
            msg.className = "message assistant thinking";
            const bubble = document.createElement("div");
            bubble.className = "bubble";
            const wrap = document.createElement("div");
            wrap.className = "typing";
            wrap.innerHTML = 'Thinking<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
            bubble.appendChild(wrap);
            msg.appendChild(bubble);
            chatEl.appendChild(msg);
            scrollToBottom();
            return {msg, bubble};
        }

        function setDisabled(disabled) {
            inputEl.disabled = disabled;
            sendBtn.disabled = disabled;
        }

        async function ask() {
            const courseId = parseInt(hiddenCourse.value, 10);
            const k = parseInt(kEl.value, 10) || 6;
            const question = inputEl.value.trim();
            if (!question || !courseId) return;

            appendMessage("user", question);
            inputEl.value = "";
            setDisabled(true);

            const thinking = appendThinking();

            const payload = {course_id: courseId, question, k};
            try {
                const res = await fetch(ENDPOINT, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(payload),
                });
                const data = await res.json().catch(() => ({}));
                const answerText = data && data.answer
                    ? String(data.answer)
                    : `Sorry, something went wrong (${res.status}).`;
                thinking.bubble.textContent = answerText;
                thinking.msg.classList.remove("thinking");
            } catch (err) {
                console.error("[assistant] fetch error", err);
                thinking.bubble.textContent = "Network error. Please try again.";
                thinking.msg.classList.remove("thinking");
            } finally {
                setDisabled(false);
                inputEl.focus();
                scrollToBottom();
            }
        }

        sendBtn.addEventListener("click", ask);
        inputEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter") ask();
        });
    </script>
{% endblock %}
