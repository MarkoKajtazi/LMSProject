{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{{ course.title }} – Chat</title>
    <link rel="stylesheet" href="{% static 'bootstrap-5.3.7-dist/css/bootstrap.css' %}">
    <style>
        .chat-box {
            height: 60vh;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: .75rem;
            padding: 1rem;
        }

        .msg {
            margin-bottom: .75rem;
        }

        .msg .meta {
            font-size: .8rem;
            opacity: .7;
        }

        .msg .bubble {
            background: #f8f9fa;
            border-radius: .75rem;
            padding: .5rem .75rem;
            display: inline-block;
        }
    </style>
</head>
<body class="container py-4">
<h3 class="mb-3">{{ course.title }} – Group Chat</h3>

<div id="chat" class="chat-box mb-3">
    {% for m in messages %}
        <div class="msg">
            <div class="meta">
                {{ m.sender.get_full_name|default:m.sender.username }} • {{ m.created_at }}
            </div>
            <div class="bubble">{{ m.content|linebreaksbr }}</div>
        </div>
    {% endfor %}
</div>

<form id="chat-form" class="d-flex gap-2">
    <input id="chat-input" type="text" class="form-control" placeholder="Type a message…" autocomplete="off">
    <button class="btn btn-primary" type="submit">Send</button>
</form>

<script>
    const courseId = {{ course.id }};
    const chatBox = document.getElementById("chat");
    const input = document.getElementById("chat-input");
    const form = document.getElementById("chat-form");

    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const socket = new WebSocket(`${wsScheme}://${location.host}/ws/courses/${courseId}/chat/`);

    socket.onmessage = (e) => {
        const m = JSON.parse(e.data);
        const wrap = document.createElement("div");
        wrap.className = "msg";
        wrap.innerHTML = `
        <div class="meta">${m.sender} • ${new Date(m.created_at).toLocaleString()}</div>
        <div class="bubble"></div>`;
        wrap.querySelector(".bubble").textContent = m.content;
        chatBox.appendChild(wrap);
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    form.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;
        socket.send(JSON.stringify({message: text}));
        input.value = "";
    });

    // auto-scroll on load
    chatBox.scrollTop = chatBox.scrollHeight;
</script>
</body>
</html>
